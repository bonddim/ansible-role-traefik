---
- name: Ensure traefik docker network state
  docker_network:
    name: "{{ traefik_docker_network }}"
    state: present

- name: Launch traefik container
  docker_container:
    name: traefik
    image: traefik:latest
    pull: true
    ignore_image: false
    state: started
    recreate: false
    restart: "{{ traefik_config.results.0.changed | default(false) }}"
    restart_policy: unless-stopped
    container_default_behavior: "{{ (ansible_version.full is version('2.10', '>=')) | ternary('compatibility', omit) }}"
    networks:
      - name: "{{ traefik_docker_network }}"
    networks_cli_compatible: true
    network_mode: default
    security_opts:
      - no-new-privileges:true
    published_ports:
      - "80:80"
      - "443:443"
    command:
      - --configfile "{{ traefik_configfile_static }}"
    env: "{{ traefik_env }}"
    volumes: "{{ traefik_mount_volumes | select | list }}"
  vars:
    traefik_mount_volumes:
      - "{{ traefik_data }}:{{ traefik_data }}"
      - "{{ traefik_provider_docker_endpoint | ternary('', '/var/run/docker.sock:/var/run/docker.sock:ro') }}"
